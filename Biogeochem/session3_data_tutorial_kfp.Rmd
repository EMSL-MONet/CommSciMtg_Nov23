---
title: "Session 3: Data Tutorial"
output: html_document
date: "2023-10-23"
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

## Setup

Load packages

```{r packages}
library(tidyverse)
library(maptools); library(sf) # for biomes
library(ggthemes) # for theme_map
theme_set(theme_bw(base_size = 12))
```

Import files

```{r import_files}
bgc_data = read_csv("Biogeochem/data/bgc_data.csv")
metadata = read_csv("Biogeochem/data/bgc_metadata.csv")
bgc_analyses = read_csv("Biogeochem/data/bgc_analyses.csv") %>% dplyr::select(column, abbreviated, analysis_type)
```

Process the data. We will use the data in two forms - longform and wideform.

```{r process}
data_long = 
  bgc_data %>% 
  pivot_longer(cols = -c(Site_Code, Location), names_to = "column") %>% 
  left_join(bgc_analyses) %>% 
  left_join(metadata %>% dplyr::select(Site_Code, Lat, Long, biome_name))

data_wide = 
  data_long %>% 
  dplyr::select(-c(column, analysis_type)) %>% 
  pivot_wider(names_from = "abbreviated", values_from = "value")
```


## BASIC EXPLORATION

```{r jitters, fig.height=10, fig.width=12}
data_long %>% 
  ggplot(aes(x = abbreviated, y = value, color = Location))+
  geom_jitter(width = 0.3)+
  facet_wrap(~analysis_type, scales = "free")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


We had sites across five biomes

```{r biome_numbers}

biome_numbers = 
  data_long %>% 
  distinct(Site_Code, biome_name) %>% 
  group_by(biome_name) %>% 
  dplyr::summarise(n = n()) %>% 
#  mutate(biome_name = replace_na(biome_name, "unknown")) %>% 
  force()

biome_numbers %>% knitr::kable()
```

```{r biome_numbers_gg, eval=FALSE}

biome_numbers %>% 
  drop_na() %>% 
#  mutate(biome_name = fct_reorder(biome_name, -n)) %>% 
#  arrange(desc(n)) %>% 
  ggplot(aes(x = 1, y = biome_name, fill = biome_name))+
  geom_point(aes(size = n), alpha = 1, shape = 21, color = "black", stroke = 1)+
  geom_text(aes(label = n), color = "white", fontface = "bold", size = 6)+
  geom_text(aes(label = biome_name, x = 1.25), 
            color = "black", hjust = 0, size = 6)+
  #scale_color_manual(values = PNWColors::pnw_palette("Bay", 6))+
  scale_fill_manual(values = soilpalettes::soil_palette("redox2", 5))+
  scale_radius(range = c(10, 32))+
  xlim(0, 5)+
  theme_void()+
  theme(legend.position = "none",
        panel.border = element_rect(fill = NA, color = "black"))
```

```{r biomes_map}
# biome map

make_map_biome = function(bgc_wide, VAR, TITLE = "", LEGEND = VAR){
  
  ## Set CRS
  common_crs <- 4326
  
  ## Set map size and point size
  point_size <- 2
  map_width = 9
  map_height = 6
  
  # Set up map layers for plotting
  
  ## Make US states map cropped to contiguous region
  us <- read_sf("Biogeochem/cb_2018_us_state_5m/cb_2018_us_state_5m.shp") %>% 
    st_transform(., crs = common_crs) 
  
  us_bbox <- c(xmin = -125, xmax = -60, ymin = 20, ymax = 50)
  region <- st_crop(us, y = us_bbox)
  
  # make a dataset merging metadata with site lat-longs
  df_map <- 
    bgc_wide %>% 
    filter(!is.na(Lat) & !is.na(Long)) %>% 
    st_as_sf(., coords = c("Long", "Lat"), crs = common_crs)
  
  # Make the base map with all sites
  ## base_plot <- 
  ggplot() + 
    geom_sf(data = region, fill = "white", color = "grey70") + 
    geom_sf(data = df_map, aes_string(fill = VAR), size = 7, shape = 21, color = "black", stroke = 1) + 
    labs(title = TITLE,
         fill = LEGEND)+
    ggthemes::theme_map() + 
    theme(legend.background = element_rect(fill = alpha("white", 0.0)), 
          legend.key = element_rect(fill = "transparent"), 
          legend.key.size = unit(1, "cm"),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12, face = "bold", vjust = 0.7),
          legend.position = "right",
          plot.title = element_text(size = 14, face = "bold"),
          plot.background = element_rect(color = "black", fill = NA, linewidth = 1)) + 
#    scale_color_viridis_c(option = "plasma") +
    scale_fill_manual(values = soilpalettes::soil_palette("redox2", 5))+
 NULL
  
}

make_map_biome(data_wide, VAR = "biome_name")

```



---

## CORRELATIONS AND PCAs


Use this function to set up the correlation plots for the entire dataset.  
We use the `ggcorrplot` package for this.

```{r correlations_function}

  fit_correlations_function = function(dat, TITLE = ""){
    num = 
      dat %>%       
      dplyr::select(where(is.numeric)) %>%
      drop_na()
    
    num_clean = 
      num %>% 
      rownames_to_column("row") %>% 
      pivot_longer(-row) %>% 
      separate(name, sep = "_", into = c("name")) %>% 
      pivot_wider() %>% 
      dplyr::select(-row)
    
    
    m = cor(num_clean)
    p.mat <- ggcorrplot::cor_pmat(num_clean)
    
    ggcorrplot::ggcorrplot(m, type = "lower",
                           p.mat = p.mat,
                           outline.color = "black",
                           #   lab = TRUE, 
                           insig = "blank",
                           colors = c("#E46726", "white", "#6D9EC1"),
                           title = TITLE)
    
  }

```

```{r correlation_matrix}
# this will generate a correlation matrix for the entire BGC dataset
  corr_all = fit_correlations_function(data_wide %>% dplyr::select(-Lat, -Long, -GWC))

# However, there are a lot of variables here. 
# So, for an easier plot, subset select variables and then re-run the correlation matrix.

data_wide_subset = data_wide %>% 
  dplyr::select(GWC, Ca, Mg, Na, K, Bases, CEC, 
                Sand, Silt, Clay, SO4S, NO3N, NH4N,
                TC, TN, pH, Lat, Long, Location)

fit_correlations_function(data_wide_subset %>% filter(Location == "TOP"))
```


```{r pca_function, eval=FALSE}

compute_pca = function(bgc_wide){
  library(ggbiplot)
  

  fit_pca_function = function(dat){
    
    dat %>% 
      drop_na()
    
    num = 
      dat %>%       
      dplyr::select(where(is.numeric)) %>%
      dplyr::mutate(row = row_number()) %>% 
      drop_na()
    
    num_row_numbers = num %>% dplyr::select(row)
    
    grp = 
      dat %>% 
      dplyr::select(where(is.character)) %>% 
      dplyr::mutate(row = row_number()) %>% 
      right_join(num_row_numbers)
    
    
    num = num %>% dplyr::select(-row)
    pca_int = prcomp(num, scale. = T)
    
    list(num = num,
         grp = grp,
         pca_int = pca_int)
  }
  
  ## PCA input files ----
  pca_overall = fit_pca_function(bgc_wide %>% dplyr::select(-GWC)) 
  
  ## PCA plots overall ----
  gg_pca_overall = 
    ggbiplot(pca_overall$pca_int, obs.scale = 1, var.scale = 1,
             groups = as.character(pca_overall$grp$biome_name), 
             ellipse = TRUE, circle = FALSE, var.axes = TRUE, alpha = 0) +
    geom_point(size = 4, stroke = 1.5, alpha = 0.8,
               aes(shape = pca_overall$grp$Location,
                   color = groups))+ 
    scale_shape_manual(values = c(1, 16))+
    labs(shape="",
         color = "",
         title = "Overall PCA",
         subtitle = "")+
    NULL
  
  gg_pca_overall
  
}

```

```{r pca, fig.height=10, fig.width=12, eval=FALSE}
compute_pca(data_wide)
```


**Individual Correlations**
```{r correlations_individual}

data_wide %>% 
  ggplot(aes(x = TC, y = TN))+
  geom_point()+
  geom_smooth(method = "lm", se = F)


data_wide %>% 
  ggplot(aes(x = Clay, y = Sand))+
  geom_point()+
  geom_smooth(method = "lm", se = F)


data_wide %>% 
  ggplot(aes(x = CEC, y = Clay))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_wrap(~Location)

lm(CEC ~ Clay, data = data_wide) %>% summary()


data_wide %>% 
  ggplot(aes(x = Ca, y = Bases))+
  geom_point()+
  geom_smooth(method = "lm", se = F)



data_wide %>% 
  filter(Location == "TOP") %>% 
  ggplot(aes(x = TC, y = WEOC))+
  geom_point()+
  geom_smooth(method = "lm", se = F)

```

```{r, eval=FALSE}
## additional correlations

x = 
  data_wide %>% dplyr::select(GWC, Ca, Mg, Na, K, Bases, CEC, Sand, Silt, Clay, SO4S, NO3N, NH4N,
                                                 TC, TN, pH, Location, biome_name, Site_Code)



x_long = x %>% pivot_longer(cols = -c(Site_Code, Location, biome_name, GWC))
x_long %>% 
  ggplot(aes(x = GWC, y = value))+
  geom_point()+
  facet_wrap(~name, scales = "free_y")


x_long = x %>% pivot_longer(cols = -c(Site_Code, Location, biome_name, pH))
x_long %>% 
  ggplot(aes(x = pH, y = value))+
  geom_point()+
  facet_wrap(~name, scales = "free_y")


x_long = x %>% pivot_longer(cols = -c(Site_Code, Location, biome_name, Clay))
x_long %>% 
  ggplot(aes(x = Clay, y = value))+
  geom_point()+
  facet_wrap(~name, scales = "free_y")


```

--- 

## JITTER PLOTS

These are "jittered" scatter plots showing distribution of the variables by depth or by biome.


1. total carbon (TC)

TC ANOVA

```{r}

lm((TC) ~ Location * biome_name, data = data_wide) %>% car::Anova()

```


plot TC by depth

```{r}

data_wide %>% 
  ggplot(aes(x = Location, y = TC, color = Location))+
  #geom_jitter(size = 3, width = 0.2)+
  geom_boxplot(position = position_dodge(width = 0.5), width = 0.3, outlier.colour = NA)+
  geom_jitter(size = 3, width = 0.3)

```

plot TC by biome

```{r}
set.seed(1234)
data_wide %>% 
  ggplot(aes(x = biome_name, y = TC, color = Location))+
  #geom_jitter(size = 3, width = 0.2)+
  geom_boxplot(position = position_dodge(width = 0.5), width = 0.3)+
  geom_point(size = 3,
             position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.5))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
```


2. CEC

CEC ANOVA

```{r}

lm((CEC) ~ Location * biome_name, data = data_wide) %>% car::Anova()

```

plot CEC by depth

```{r}

data_wide %>% 
  ggplot(aes(x = Location, y = CEC, color = Location))+
  #geom_jitter(size = 3, width = 0.2)+
  geom_boxplot(position = position_dodge(width = 0.5), width = 0.3, outlier.colour = NA)+
  geom_jitter(size = 3, width = 0.3)

```

plot CEC by biome

```{r}
set.seed(1234)
data_wide %>% 
  ggplot(aes(x = biome_name, y = CEC, color = Location))+
  #geom_jitter(size = 3, width = 0.2)+
  geom_boxplot(position = position_dodge(width = 0.5), width = 0.3)+
  geom_point(size = 3,
             position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.5))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
```


3. Clay

Clay ANOVA

```{r}

lm((Clay) ~ Location * biome_name, data = data_wide) %>% car::Anova()

```

plot Clay by depth

```{r}

data_wide %>% 
  ggplot(aes(x = Location, y = Clay, color = Location))+
  #geom_jitter(size = 3, width = 0.2)+
  geom_boxplot(position = position_dodge(width = 0.5), width = 0.3, outlier.colour = NA)+
  geom_jitter(size = 3, width = 0.3)

```

plot Clay by biome

```{r}
set.seed(1234)
data_wide %>% 
  ggplot(aes(x = biome_name, y = Clay, color = Location))+
  #geom_jitter(size = 3, width = 0.2)+
  geom_boxplot(position = position_dodge(width = 0.5), width = 0.3)+
  geom_point(size = 3,
             position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.5))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
```



4. WEOC

WEOC ANOVA

```{r}

lm((WEOC) ~ Location * biome_name, data = data_wide) %>% car::Anova()

```

plot WEOC by depth

```{r}

data_wide %>% 
  ggplot(aes(x = Location, y = WEOC, color = Location))+
  #geom_jitter(size = 3, width = 0.2)+
  geom_boxplot(position = position_dodge(width = 0.5), width = 0.3, outlier.colour = NA)+
  geom_jitter(size = 3, width = 0.3)

```

plot WEOC by biome

```{r}
set.seed(1234)
data_wide %>% 
  ggplot(aes(x = biome_name, y = WEOC, color = Location))+
  #geom_jitter(size = 3, width = 0.2)+
  geom_boxplot(position = position_dodge(width = 0.5), width = 0.3)+
  geom_point(size = 3,
             position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.5))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
```






---

## MAPS

This section has code to plot variables in a spatial manner on maps.  
The easiest way to do this is to run the custom `make_map` function first, which will pre-load the map and other parameters.  
You then select the variable you want to plot below.

```{r map_function}
make_map = function(bgc_wide, VAR, TITLE = "", LEGEND = VAR){
  
  ## Set CRS
  common_crs <- 4326
  
  ## Set map size and point size
  point_size <- 2
  map_width = 9
  map_height = 6
  
  # Set up map layers for plotting
  
  ## Make US states map cropped to contiguous region
  us <- read_sf("Biogeochem/cb_2018_us_state_5m/cb_2018_us_state_5m.shp") %>% 
    st_transform(., crs = common_crs) 
  
  us_bbox <- c(xmin = -125, xmax = -60, ymin = 20, ymax = 50)
  region <- st_crop(us, y = us_bbox)
  
  # make a dataset merging metadata with site lat-longs
  df_map <- 
    bgc_wide %>% 
    filter(!is.na(Lat) & !is.na(Long)) %>% 
    st_as_sf(., coords = c("Long", "Lat"), crs = common_crs)
  
  # Make the base map with all sites
  ## base_plot <- 
  ggplot() + 
    geom_sf(data = region, fill = "white", color = "grey70") + 
    geom_sf(data = df_map, aes_string(fill = VAR), size = 7, shape = 21, color = "black", stroke = 1) + 
    labs(title = TITLE,
         fill = LEGEND)+
    ggthemes::theme_map() + 
    theme(legend.background = element_rect(fill = alpha("white", 0.0)), 
          legend.key = element_rect(fill = "transparent"), 
          legend.key.size = unit(1, "cm"),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12, face = "bold", vjust = 0.7),
          legend.position = "bottom",
          plot.title = element_text(size = 14, face = "bold"),
          plot.background = element_rect(color = "black", fill = NA, linewidth = 1)) + 
#    scale_color_viridis_c(option = "plasma") +
    scale_fill_gradientn(colors = soilpalettes::soil_palette("redox2", 5))
  
}
```


Now, make the maps

```{r maps}
make_map(data_wide, VAR = "TC", LEGEND = "TC, %")
make_map(data_wide, VAR = "WEOC", LEGEND = "WEOC")
make_map(data_wide, VAR = "MBC", LEGEND = "MBC")

make_map(data_wide, VAR = "TN", LEGEND = "TN, %")

make_map(data_wide %>% filter(Location == "BTM"), VAR = "CEC")

make_map(data_wide, VAR = "Clay")
```
